#grafico lineal

require(geoR)
require(lattice)
library(rasterVis)
#tiene que estar en el mismo directorio que grafico_limari_v2_includes.R
workdir <- "C:/Users/Pablo/Dropbox/cazalac/Simgen-Limari v2/simgen/otros_scripts"
setwd(workdir)
source("grafico_limari_v2_includes.R")
#configuración
#rango de pp y temperatura, malla generada en python, no modificar.
pp <- c(101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,101.543928571,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,118.467916667,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,135.391904762,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,152.315892857,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,169.239880952,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,186.163869048,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,203.087857143,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,220.011845238,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333,236.935833333)
tt <- c(8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048,8.54601190476,9.54601190476,10.5460119048,11.5460119048,12.5460119048,13.5460119048,14.5460119048,15.5460119048,16.5460119048,17.5460119048,18.5460119048,19.5460119048,20.5460119048,21.5460119048,22.5460119048,23.5460119048,24.5460119048)
#nombre del gráfico
var <- "Embalse Paloma"

###modificación 09-02-2018
##Agrega promedios de simgen

#Directorio de Trabajo




#Dos puntos a agregar, agregar de histórico a proyectado.

#Percentil 95 de todas las simulaciones
#2030 - 2060 porque está como > y <
p95 <- promedios(workdir = "C:/Users/Pablo/Dropbox/cazalac/Simgen-Limari v2/simgen/output_sim/anual", nums = c(95), anhoinicio = 2029, anhofinal = 2061)
p95.vectorpp <- c(do.call("cbind",p95[1])) 
p95.vectortt <- c(do.call("cbind",p95[2])) 

#percentil 50
p50 <- promedios(workdir = "C:/Users/Pablo/Dropbox/cazalac/Simgen-Limari v2/simgen/output_sim/anual", nums = c(50), anhoinicio = 2029, anhofinal = 2061)
p50.vectorpp <- c(do.call("cbind",p50[1])) 
p50.vectortt <- c(do.call("cbind",p50[2])) 

#percentil 10
p10 <- promedios(workdir = "C:/Users/Pablo/Dropbox/cazalac/Simgen-Limari v2/simgen/output_sim/anual", nums = c(10), anhoinicio = 2029, anhofinal = 2061)
p10.vectorpp <- c(do.call("cbind",p10[1])) 
p10.vectortt <- c(do.call("cbind",p10[2])) 


promedioproyectadott <- (mean(as.numeric(p95.vectortt))+mean(as.numeric(p50.vectortt))+mean(as.numeric(p10.vectortt)))/3
promedioproyectadopp <- (mean(as.numeric(p95.vectorpp))+mean(as.numeric(p50.vectorpp))+mean(as.numeric(p10.vectorpp)))/3

#corresponde a la coordenada X de los puntos 
puntosx <- c(167.473887814,promedioproyectadopp,p95.vectorpp,p50.vectorpp,p10.vectorpp)
#corresponde a la coordenada Y de los puntos
puntosy <- c(16.8596276476,promedioproyectadott, p95.vectortt,p50.vectortt, p10.vectortt)


#rellenamos
p95.phcpuntos <- vector('numeric')
p95.typos  <- vector('numeric')
p10.phcpuntos <- vector('numeric')
p10.typos  <- vector('numeric')
p50.phcpuntos <- vector('numeric')
p50.typos  <- vector('numeric')
for (variable in 1:length(p95.vectorpp)) {
  p95.phcpuntos <- c(p95.phcpuntos, 0)
  p95.typos <- c(p95.typos, "p")
}
for (variable in 1:length(p50.vectorpp)) {
  p50.phcpuntos <- c(p50.phcpuntos, 1)
  p50.typos <- c(p50.typos, "p")
}
for (variable in 1:length(p10.vectorpp)) {
  p10.phcpuntos <- c(p10.phcpuntos, 2)
  p10.typos <- c(p10.typos, "p")
}
#corresponde al tipo de punto a colocar en el gráfico
pchpuntos <- c(4,19,p95.phcpuntos,p50.phcpuntos,p10.phcpuntos)
typos <- c("p","p",p95.typos,p50.typos,p10.typos)

#Volumen Embalse-Paloma
cc <- c(126627644.549,140369072.091,155674518.242,136991308.966,130071172.948,111451503.057,98139447.4714,87863475.388,81025940.3255,73810185.9453,68586935.6823,64494858.3672,61539894.4427,58899247.1641,56719542.0365,55770649.9375,53164024.7839,182410677.622,217492268.417,253220035.909,234176491.357,219637429.484,187030929.505,160817099.177,141443968.703,128047664.638,115605357.789,106329429.047,98269284.6927,93685908.9297,89328794.9505,84958306.651,83777725.4948,79828007.1276,286505403.557,387567080.107,470043479.576,450122849.734,413128445.031,338886686.544,272935729.708,235439112.607,210991895.549,188662173.706,171785315.443,158402872.93,149138275.654,139906977.042,131361056.044,128805215.036,122521311.242,507037029.143,547750630.911,593555972.784,575676604.292,551566684.682,499919349.13,450222345.961,396575865.872,355080909.979,307341582.812,274641575.443,251213492.289,238769367.792,224072414.958,208928375.724,202523780.857,191055234.458,628616473.216,631092453.88,640830602.953,629696539.047,618058426.789,595879624.258,567916135.562,528635895.94,484740682.974,444511901.69,401694311.938,367302277.411,341599089.703,320574434.25,304860311.82,289220158.406,275394412.823,646033365.169,654525618.409,659205224.091,654180037.656,647516231.143,634060221.812,616686713.461,596542762.25,575956144.789,552278243.036,522808371.339,485598008.229,451595058.214,418185639.466,385942343.133,363723622.849,343132269.346,655440471.451,662571267.938,667977674.607,669003534.185,666359770.893,656113512.154,646097161.268,634375598.078,616031464.367,600059355.945,583574329.812,563763405.31,542871857.102,521485261.672,493934607.219,459894444.57,428467262.299,662268681.846,668505894.539,673721571.995,675494309.224,675893413.214,672701225.294,664485264.24,655603669.57,644942867.266,633048686.818,616292322.174,601750410.956,588308143.833,575269935.281,559948499.547,538141969.107,517582503.406,667509626.406,673560640.378,678307663.372,679939363.542,680864836.057,679804255.198,676951763.221,672290386.906,663663472.982,654295661.357,641954048.263,629937765.242,617779958.276,605095726.422,595439485.005,582249883.849,569315744.706)
cc <- cc/1000000


############Se genera grid#################################

elevation.df = data.frame(x = pp, y = tt, z = cc )
elevation.loess = loess(z ~ x*y, data = elevation.df, degree = 2, span = 0.5)
elevation.fit = expand.grid(list(x = seq(min(pp), max(pp)*.8, 0.1), y = seq(min(tt), max(tt), 0.01)))
z = predict(elevation.loess, newdata = elevation.fit)
elevation.fit$Height = as.numeric(z)


#########nuevo grafico todo incluido##############

yy <- list()
xx <- seq(50, 250, 0.05)
for (variable in 1:length(xx)) {
  yy[variable] = 16.85963
}
recta <- data.frame(x = as.numeric(xx), y = as.numeric(yy))
zz = predict(elevation.loess, newdata = recta)
recta$z = as.numeric(zz)
recta <- recta[complete.cases(recta), ]

#buscando stress limite
recta[which(abs(recta$z-330)==min(abs(recta$z-330))),]
#generando los gráficos
#pp vs volumen
plot(recta$x,recta$z,xaxs = "i", xlim=c(210,120), col="blue", type = "l", lwd = 2.5, xlab="Precipitación [mm]", ylab="Volumen [Mm³]", main="Embalse Paloma T=16.86°C")
#lines(c(max(recta$x),min(recta$x)),c(quantile(cc, c(limite)),quantile(cc, c(limite))), type="l", lwd=2.5,  col="red")
#limite crítico
lines(c(150,150),c(0,330), lty=2)
text(195,500,labels="ΔV")

arrows(200,332, 200,600, xpd = TRUE, code = 3, lty=2)
arrows(210,250, 150,250, xpd = TRUE, code = 3, lty=2)
text(200,200,labels="ΔP")
#ww <- 1:10
#plot(ww, xlim=c(200,100), ylim=c(150,500), xlab="Precipitación [mm]", ylab="Volumen [Mm³]", type="n")

#quantile
#lines(rev(recta$x), recta$z, type="l", lwd=2.5, col="blue")

legend("topright", legend=c("Límite Crítico","P10","P50","P95","Tprom"), lty=c(1,1,1,1,1), col=c("red","#00204A","#005792","#00BBF0","blue"), lwd=c(2.5,2.5,2.5,2.5), cex=0.7)

#title(var)

#promedio con 10
rangox <- c(mean(as.numeric(p10.vectorpp)),167.4739)
rangoy <- c(16.85963,mean(as.numeric(p10.vectortt)))
yy10 <- list()
xx <- seq(min(unlist(rangox))-100, max(unlist(rangox))+100, 0.5)

for (variable in 1:length(xx)) {
  yy10[variable] = lm(unlist(rangoy) ~ unlist(rangox))$coeff[[2]]*as.numeric(xx[variable])+lm(unlist(rangoy) ~ unlist(rangox))$coeff[[1]]
}
recta10 <- data.frame(x = as.numeric(xx), y = as.numeric(yy10))
recta10$x <- rev(recta10$x)
zz10 = predict(elevation.loess, newdata = recta10)
recta10$z = as.numeric(zz10)
lines(recta10$x, recta10$z, type="l", lwd=2.5, col="#00204A")

#promedio con 50
rangox <- c(mean(as.numeric(p50.vectorpp)),167.4739)
rangoy <- c(16.85963,mean(as.numeric(p50.vectortt)))
yy50 <- list()
xx <- seq(min(unlist(rangox))-100, max(unlist(rangox))+100, 0.5)
for (variable in 1:length(xx)) {
  yy50[variable] = lm(unlist(rangoy) ~ unlist(rangox))$coeff[[2]]*as.numeric(xx[variable])+lm(unlist(rangoy) ~ unlist(rangox))$coeff[[1]]
}
recta50 <- data.frame(x = as.numeric(xx), y = as.numeric(yy50))
recta50$x <- rev(recta50$x)
zz50 = predict(elevation.loess, newdata = recta50)
recta50$z = as.numeric(zz50)
#recta50$y = rev(recta50$y)
lines(recta50$x, recta50$z, type="l", lwd=2.5, col="#005792")

#promedio con 95
rangox <- c(mean(as.numeric(p95.vectorpp)),167.4739)
rangoy <- c(16.85963,mean(as.numeric(p95.vectortt)))
yy95 <- list()
xx <- seq(min(unlist(rangox))-100, max(unlist(rangox))+100, 0.5)
for (variable in 1:length(xx)) {
  yy95[variable] = lm(unlist(rangoy) ~ unlist(rangox))$coeff[[2]]*as.numeric(xx[variable])+lm(unlist(rangoy) ~ unlist(rangox))$coeff[[1]]
}
recta95 <- data.frame(x = as.numeric(xx), y = as.numeric(yy95))
recta95$x <- rev(recta95$x)
zz95 = predict(elevation.loess, newdata = recta95)
recta95$z = as.numeric(zz95)
#recta95$y = rev(recta95$y)
lines(recta95$x, recta95$z, type="l", lwd=2.5, col="#00BBF0")
lines(c(167.4739,167.4739),c(0,450), lty=2)
text(160,520,labels="P Promedio")

#330 es el limite de embalse
lines(c(100,300),c(330,330), type="l", lwd=2.5,  col="red")
